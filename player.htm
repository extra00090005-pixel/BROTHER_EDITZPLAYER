<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brother_editz05 | Web Player</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; color: white; background-color: #121212; }
        
        #bg-video { position: fixed; right: 0; bottom: 0; min-width: 100%; min-height: 100%; z-index: -1; object-fit: cover; filter: brightness(0.4) blur(3px); }

        .player-container {
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1); padding: 30px; border-radius: 30px; text-align: center;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); width: 400px;
        }

        .branding { font-size: 16px; letter-spacing: 3px; text-transform: uppercase; color: #1DB954; margin-bottom: 20px; font-weight: bold; }

        .search-container { display: flex; gap: 10px; margin-bottom: 30px; }
        #search-input { flex: 1; padding: 10px 15px; border-radius: 20px; border: none; outline: none; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; }
        #search-btn { background: #1DB954; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; color: white; font-weight: bold; transition: 0.3s; }
        #search-btn:hover { background: #1ed760; transform: scale(1.05); }

        .stopwatch-ring {
            position: relative; width: 250px; height: 250px; margin: 0 auto 25px; border-radius: 50%;
            background: conic-gradient(#1DB954 0deg, rgba(255, 255, 255, 0.1) 0deg);
            display: flex; justify-content: center; align-items: center; box-shadow: 0 0 20px rgba(29, 185, 84, 0.2); transition: background 0.1s linear;
        }
        .stopwatch-ring::before { content: ""; position: absolute; width: 235px; height: 235px; background-color: #121212; border-radius: 50%; }
        
        .album-art { position: relative; width: 215px; height: 215px; border-radius: 50%; object-fit: cover; z-index: 10; animation: spin 15s linear infinite; animation-play-state: paused; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .track-name { font-size: 20px; font-weight: bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .artist-name { font-size: 14px; color: #b3b3b3; margin-bottom: 25px; }

        .controls { display: flex; justify-content: center; align-items: center; gap: 25px; }
        .btn-ctrl { background: none; border: none; color: white; font-size: 24px; cursor: pointer; transition: 0.2s; }
        .btn-ctrl:hover { color: #1DB954; transform: scale(1.1); }
        .play-btn { background: white; color: black; width: 60px; height: 60px; border-radius: 50%; font-size: 20px; display: flex; justify-content: center; align-items: center; }
        .play-btn:hover { background: #1DB954; color: white; }
    </style>
</head>
<body>

    <video autoplay muted loop id="bg-video">
        <source src="https://cdn.pixabay.com/video/2020/05/25/40140-424855427_large.mp4" type="video/mp4">
    </video>

    <div class="player-container">
        <div class="branding">Brother_editz05 Player</div>
        
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Search any song...">
            <button id="search-btn">üîç Play</button>
        </div>

        <div class="stopwatch-ring" id="progress-ring">
            <img src="https://via.placeholder.com/215/121212/1DB954?text=Music" class="album-art" id="album-img">
        </div>

        <div class="track-name" id="track-name">Ready to play</div>
        <div class="artist-name" id="artist-name">Search a song above</div>

        <div class="controls">
            <button class="btn-ctrl" id="prev-btn">‚èÆ</button>
            <button class="btn-ctrl play-btn" id="toggle-btn">‚ñ∂</button>
            <button class="btn-ctrl" id="next-btn">‚è≠</button>
        </div>
    </div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        const hash = window.location.hash.substring(1).split('&').reduce(function (initial, item) {
            if (item) { var parts = item.split('='); initial[parts[0]] = decodeURIComponent(parts[1]); }
            return initial;
        }, {});
        
        window.location.hash = ''; 
        let _token = hash.access_token;

        if (!_token) {
            alert("Login required! Redirecting...");
            window.location.href = "index.html"; 
        }

        let player;
        let myDeviceId = ""; 
        let trackDuration = 0;

        window.onSpotifyWebPlaybackSDKReady = () => {
            player = new Spotify.Player({
                name: 'Brother_editz05 Web Player',
                getOAuthToken: cb => { cb(_token); },
                volume: 0.8
            });

            player.addListener('ready', ({ device_id }) => {
                console.log('Ready with Device ID', device_id);
                myDeviceId = device_id;

                // Make this device active automatically
                fetch('https://api.spotify.com/v1/me/player', {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${_token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "device_ids": [device_id], "play": false })
                }).then(() => console.log("Device Active!"));
            });

            player.addListener('player_state_changed', state => {
                if (!state) return;
                document.getElementById('track-name').innerText = state.track_window.current_track.name;
                document.getElementById('artist-name').innerText = state.track_window.current_track.artists[0].name;
                
                const albumImg = document.getElementById('album-img');
                albumImg.src = state.track_window.current_track.album.images[0].url;

                const isPaused = state.paused;
                document.getElementById('toggle-btn').innerText = isPaused ? '‚ñ∂' : '‚è∏';
                albumImg.style.animationPlayState = isPaused ? 'paused' : 'running';

                trackDuration = state.track_window.current_track.duration_ms;
            });

            player.connect();
        };

        document.getElementById('toggle-btn').onclick = () => { player.togglePlay(); };
        document.getElementById('prev-btn').onclick = () => { player.previousTrack(); };
        document.getElementById('next-btn').onclick = () => { player.nextTrack(); };

        function updateStopwatch(position, duration) {
            if(duration === 0) return;
            const percentage = (position / duration) * 360;
            document.getElementById('progress-ring').style.background = `conic-gradient(#1DB954 ${percentage}deg, rgba(255, 255, 255, 0.1) 0deg)`;
        }

        setInterval(() => {
            if (player) {
                player.getCurrentState().then(state => {
                    if (!state || state.paused) return;
                    updateStopwatch(state.position, state.track_window.current_track.duration_ms);
                });
            }
        }, 1000); 

        // Search and Play Direct
        document.getElementById('search-btn').onclick = async () => {
            const query = document.getElementById('search-input').value;
            if(!query) return alert("Pehle gaane ka naam likho!");

            const searchResponse = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=1`, {
                headers: { 'Authorization': `Bearer ${_token}` }
            });
            const searchData = await searchResponse.json();
            
            if(!searchData.tracks || searchData.tracks.items.length === 0) return alert("Gaana nahi mila!");
            
            const trackUri = searchData.tracks.items[0].uri;

            await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${myDeviceId}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${_token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ "uris": [trackUri] })
            });
        };
    </script>
</body>
</html>
